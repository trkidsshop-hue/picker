<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS Smart System V.3.2</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .sidebar-item-active { background-color: #374151; border-left: 4px solid #3b82f6; color: white; }
        .hidden { display: none; }
        .menu-link { transition: all 0.2s; cursor: pointer; }
        .menu-link:hover { background-color: #4b5563; }
        #webcam { transform: scaleX(-1); border-radius: 1.5rem; background: #000; }
        .order-modal { background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <script>
        const SUPABASE_URL = 'https://txekfroeygjtgizbsfcx.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4ZWtmcm9leWdqdGdpemJzZmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxNzIzNzIsImV4cCI6MjA4Mjc0ODM3Mn0.PkdxsyhfqVLQB3Kk3uajd1bAiSDUOYPsZT_cvFjNaBE';
        const PROJECT_A_IMAGE_URL = 'https://otswcrrcidtkpjijirax.supabase.co/storage/v1/object/public/Product_Pic/';
        
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null;
        let adminStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let currentInspectionItems = [];
        let currentInspectionIndex = 0;
    </script>

    <!-- 1. LOGIN PAGE -->
    <div id="login-page" class="flex items-center justify-center h-screen bg-slate-900 px-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
            <h1 class="text-3xl font-black mb-6 text-slate-800 uppercase tracking-widest">WMS LOGIN</h1>
            <div class="space-y-4">
                <input type="text" id="l_user" placeholder="Username" onkeydown="if(event.key === 'Enter') handleLogin()" class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-blue-400">
                <input type="password" id="l_pass" placeholder="Password" onkeydown="if(event.key === 'Enter') handleLogin()" class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-blue-400">
                <button onclick="handleLogin()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg text-lg">เข้าสู่ระบบ</button>
            </div>
        </div>
    </div>

    <!-- 2. ADMIN LAYOUT -->
    <div id="admin-layout" class="hidden flex h-screen overflow-hidden">
        <aside class="w-64 bg-slate-800 text-gray-300 flex flex-col shrink-0">
            <div class="p-6 text-xl font-black text-white border-b border-slate-700 tracking-tighter">WMS SYSTEM</div>
            <nav class="flex-1 mt-4 text-sm font-medium">
                <div onclick="switchMenu('menu-upload')" class="menu-link flex items-center p-4" id="link-upload"><i class="fas fa-file-import w-8"></i> <span>จัดสินค้า</span></div>
                <div onclick="switchMenu('menu-review')" class="menu-link flex items-center p-4" id="link-review"><i class="fas fa-video w-8"></i> <span>ตรวจสินค้า</span></div>
                <div onclick="switchMenu('menu-kpi')" class="menu-link flex items-center p-4" id="link-kpi"><i class="fas fa-chart-pie w-8"></i> <span>KPI</span></div>
                <div onclick="switchMenu('menu-notif')" class="menu-link flex items-center p-4 relative" id="link-notif"><i class="fas fa-bell w-8"></i> <span>แจ้งเตือน</span><span id="notif-badge" class="absolute right-4 bg-red-600 text-white text-[10px] px-1.5 py-0.5 rounded-full hidden font-bold">0</span></div>
                <div onclick="switchMenu('menu-settings')" class="menu-link flex items-center p-4" id="link-settings"><i class="fas fa-sliders-h w-8"></i> <span>ตั้งค่า</span></div>
            </nav>
            <div class="p-4 border-t border-slate-700 mt-auto bg-slate-900/50">
    <div class="flex items-center justify-between">
        <!-- ชื่อ User พร้อมไอคอน -->
        <div class="flex items-center text-sm font-semibold text-gray-200">
            <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center mr-2 shadow-inner">
                <i class="fas fa-user text-xs text-white"></i>
            </div>
            <span id="user-display" class="truncate max-w-[100px]">Admin</span>
        </div>
        
        <!-- ปุ่ม Logout แบบทันสมัย -->
        <button onclick="logout()" class="flex items-center gap-1 px-3 py-1.5 rounded-lg bg-red-500/10 text-red-400 text-xs font-bold hover:bg-red-500 hover:text-white transition-all duration-300 group">
            <span>Logout</span>
            <i class="fas fa-sign-out-alt group-hover:translate-x-1 transition-transform"></i>
        </button>
    </div>
</div>
        </aside>

        <main class="flex-1 overflow-y-auto p-8 bg-gray-50">
            <!-- Menu: จัดสินค้า -->
            <section id="menu-upload" class="menu-section hidden">
                <h2 class="text-3xl font-black mb-6">จัดสินค้า</h2>
                <div class="bg-white p-6 rounded-2xl shadow-sm border mb-8 flex gap-4 items-end">
                    <div class="flex-1"><label class="text-[14px] font-bold text-gray-400 uppercase">1. เลือกไฟล์ Excel</label><input type="file" id="excelFile" class="w-full border p-2 rounded-lg mt-1 text-sm"></div>
                    <div class="w-64"><label class="text-[14px] font-bold text-gray-400 uppercase">2. มอบหมายพนักงาน</label><select id="pickerSelect" class="w-full border p-2.5 rounded-lg mt-1 text-sm"></select></div>
                    <button onclick="handleUpload()" class="bg-blue-600 text-white px-8 py-2.5 rounded-lg font-bold shadow-md hover:bg-blue-700">อัปโหลดงาน</button>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border overflow-hidden">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b">
                        <h3 class="font-bold">Dashboard รายการใบงาน (Order Sheets)</h3>
                        <div class="flex gap-2 items-center">
                            <select id="filter_user" class="border p-2 rounded text-xs outline-none bg-white">
                                <option value="">พนักงานทั้งหมด</option>
                            </select>
                            <input type="date" id="filter_date" class="border p-2 rounded text-xs outline-none">
                            <button onclick="loadOrdersDashboard()" class="bg-blue-600 text-white px-4 py-1 rounded text-xs font-bold hover:bg-blue-700 transition">Filter</button>
                        </div>
                    </div>
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-100 text-[14px] uppercase text-gray-500">
                            <tr>
                                <th class="p-4">ใบงาน (Order ID)</th>
                                <th class="p-4">วันที่มอบหมาย</th>
                                <th class="p-4">พนักงาน</th>
                                <th class="p-4 text-center">ความคืบหน้า (หยิบ/ทั้งหมด)</th>
                                <th class="p-4">สถานะภาพรวม</th>
                                <th class="p-4 text-center">รายละเอียด</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardBody" class="divide-y text-gray-600"></tbody>
                    </table>
                </div>
            </section>

            <!-- Menu: ตรวจสินค้า / KPI / แจ้งเตือน / ตั้งค่า (เหมือนเดิม) -->
            <section id="menu-review" class="menu-section hidden">
                <div class="flex justify-between items-end mb-6">
                    <h2 class="text-3xl font-black text-slate-800">ตรวจสินค้า</h2>
                    <div class="flex gap-2">
                        <select id="reviewOrderSelect" class="border p-2.5 rounded-lg w-64 text-sm"></select>
                        <button onclick="startInspection()" class="bg-blue-600 text-white px-6 rounded-lg font-bold">เริ่มเช็คสินค้า</button>
                    </div>
                </div>
                <div class="grid grid-cols-12 gap-8">
                    <div class="col-span-4 space-y-4 h-[70vh] overflow-y-auto pr-2" id="inspectionList"></div>
                    <div class="col-span-8">
                        <div class="bg-slate-900 aspect-video rounded-3xl shadow-2xl relative border-8 border-white overflow-hidden">
                            <video id="webcam" autoplay muted class="w-full h-full object-cover"></video>
                            <div id="recStatus" class="absolute top-6 right-6 flex items-center bg-red-600 px-4 py-2 rounded-full hidden shadow-lg text-white text-[10px] font-bold uppercase tracking-widest"><span class="w-2 h-2 bg-white rounded-full animate-ping mr-2"></span>Recording</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="menu-kpi" class="menu-section hidden"><h2 class="text-3xl font-black mb-6 text-slate-800">KPI Performance</h2><div id="kpiStats" class="grid grid-cols-3 gap-6"></div></section>
            <section id="menu-notif" class="menu-section hidden"><h2 class="text-3xl font-black mb-6 text-slate-800">ศูนย์แจ้งเตือน</h2><div class="bg-white rounded-2xl shadow-sm border overflow-hidden divide-y" id="notifList"></div></section>
            <section id="menu-settings" class="menu-section hidden">
                <h2 class="text-3xl font-black mb-6 text-slate-800">ตั้งค่าระบบ</h2>
                <div class="grid grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-2xl border shadow-sm"><h3 class="font-bold text-gray-400 text-[10px] uppercase tracking-widest mb-4 border-b pb-2 text-slate-800">จัดการพนักงาน</h3><div class="space-y-3 mb-6 bg-gray-50 p-4 rounded-xl"><input type="text" id="nu" placeholder="Username" class="w-full border p-2.5 rounded-lg text-sm"><input type="text" id="np" placeholder="Password" class="w-full border p-2.5 rounded-lg text-sm"><select id="nr" class="w-full border p-2.5 rounded-lg text-sm"><option value="picker">Picker (ผู้จัด)</option><option value="admin">Admin (ผู้ตรวจ)</option></select><button onclick="addUser()" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold text-sm shadow-md hover:bg-blue-700">+ เพิ่มพนักงาน</button></div><div id="userList" class="divide-y max-h-64 overflow-y-auto"></div></div>
                    <div class="bg-white p-6 rounded-2xl border shadow-sm"><h3 class="font-bold text-gray-400 text-[10px] uppercase tracking-widest mb-4 border-b pb-2 text-slate-800">หัวข้อแจ้งเตือน</h3><div class="flex gap-2 mb-4"><input type="text" id="nt" class="flex-1 border p-2.5 rounded-lg text-sm" placeholder="เพิ่มหัวข้อใหม่..."><button onclick="addTopic()" class="bg-slate-800 text-white px-5 rounded-lg font-bold hover:bg-black transition">+</button></div><div id="topicList" class="divide-y max-h-96 overflow-y-auto"></div></div>
                </div>
            </section>
        </main>
    </div>

    <!-- 3. MODAL FOR ORDER DETAILS -->
    <div id="detail-modal" class="hidden fixed inset-0 z-50 order-modal flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl max-h-[90vh] rounded-3xl overflow-hidden flex flex-col shadow-2xl">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-black text-xl text-slate-800" id="modal-title">รายละเอียดใบงาน</h3>
                <button onclick="closeDetailModal()" class="text-gray-400 hover:text-red-500 text-2xl"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-[14px] uppercase text-gray-500">
                        <tr>
                            <th class="p-3">รูปภาพ</th>
                            <th class="p-3">สินค้า</th>
                            <th class="p-3">จุดเก็บ</th>
                            <th class="p-3">จำนวน</th>
                            <th class="p-3">สถานะรายการ</th>
                        </tr>
                    </thead>
                    <tbody id="modal-body" class="divide-y"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 3. MOBILE PICKER LAYOUT (V.3.3 - ปรับปรุงใหม่หน้าเดียวไม่เลื่อน) -->
    <div id="picker-layout" class="hidden h-screen bg-slate-900 text-white flex flex-col overflow-hidden">
        <!-- ส่วนหัว: แสดงชื่อ, เวลา, และลำดับงาน -->
        <!-- Header: ปรับปรุงใหม่ V.3.4 -->
        <header class="p-3 border-b border-slate-800 flex justify-between items-center bg-slate-900/90 sticky top-0 z-20">
            <!-- ซ้าย: พนักงาน -->
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-500 uppercase font-black">พนักงาน</span>
                <span id="p-name" class="text-sm font-bold text-blue-400 leading-none">---</span>
            </div>
            
            <!-- กลาง: เวลา (HH:MM นาที) -->
            <div class="flex flex-col items-center">
                <span class="text-[10px] text-gray-500 uppercase font-black">เวลาที่ใช้</span>
                <div class="flex items-baseline gap-1">
                    <span id="p-timer" class="text-xl font-mono font-black text-yellow-400">00:00</span>
                    <span class="text-[10px] text-yellow-400 font-bold">ชั่วโมง:นาที</span>
                </div>
            </div>

            <!-- ขวา: ลำดับ และ ปุ่ม Logout -->
            <div class="flex flex-col items-end gap-1">
                <button onclick="logout()" class="bg-red-600 text-white text-[10px] px-3 py-1.5 rounded-lg font-black shadow-lg active:scale-95 transition-all">
                    LOGOUT
                </button>
                <span class="text-[10px] font-bold text-gray-400">
                    <span id="p-current-idx" class="text-green-400">0</span> / <span id="p-total-items">0</span>
                </span>
            </div>
        </header>

        <!-- ส่วนเนื้อหา: รูปและปุ่มแจ้งเตือน -->
        <div id="picker-content" class="flex-1 flex flex-col p-4 justify-between overflow-hidden">
            <div id="p-job-card" class="bg-white text-slate-900 w-full rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col hidden" style="max-height: 70vh;">
                <!-- รูปภาพสินค้า (ปรับให้พอดีจอ) -->
                <div class="relative flex-1 bg-gray-100 overflow-hidden">
                    <img id="p-img" src="" class="w-full h-full object-contain">
                    <div class="absolute top-4 left-4 bg-red-600 text-white px-5 py-2 rounded-2xl font-black text-4xl shadow-lg border-2 border-white">
                        <span id="p-loc">---</span>
                    </div>
                </div>
                
                <div class="p-6">
                    <h2 class="text-xl font-bold leading-tight mb-4 text-slate-800 line-clamp-2" id="p-prod">---</h2>
                    <div class="flex items-center justify-between bg-slate-50 p-4 rounded-3xl border border-slate-100">
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-400 font-bold uppercase">จำนวนเบิก</span>
                            <span class="text-5xl font-black text-slate-900" id="p-qty">0</span>
                        </div>
                        <!-- ปุ่มแจ้งเตือนขนาดใหญ่ -->
                        <button onclick="openAlertModal()" class="bg-yellow-500 text-white px-8 py-5 rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-transform flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle text-2xl"></i> แจ้งปัญหา
                        </button>
                    </div>
                </div>
            </div>

            <!-- ปุ่มใหญ่สำหรับกดไปรายการถัดไป -->
            <button id="p-btn-next" onclick="pickerFinishItem()" class="w-full bg-green-500 py-8 rounded-[2.5rem] text-4xl font-black shadow-lg shadow-green-900/40 hidden active:scale-95 transition-all border-b-8 border-green-700 mt-2">
                หยิบเสร็จแล้ว
            </button>

            <div id="p-no-job" class="text-center text-slate-500 italic py-20">
                <i class="fas fa-box-open text-6xl mb-4 block opacity-20"></i>
                ไม่มีงานที่ได้รับมอบหมาย
            </div>
        </div>

        <!-- หน้าต่างเลือกหัวข้อแจ้งเตือน (แทน prompt เดิม) -->
        <div id="alert-modal" class="hidden fixed inset-0 z-[100] bg-slate-900/95 flex items-center justify-center p-6 transition-all">
            <div class="bg-white w-full max-w-sm rounded-[3rem] overflow-hidden text-slate-900 shadow-2xl scale-in">
                <div class="p-8 bg-slate-50 border-b flex justify-between items-center">
                    <h3 class="font-black text-2xl">เลือกปัญหาที่พบ</h3>
                    <button onclick="closeAlertModal()" class="text-gray-300 hover:text-red-500 text-3xl transition-colors"><i class="fas fa-times-circle"></i></button>
                </div>
                <div id="topic-options" class="p-6 grid grid-cols-1 gap-3 overflow-y-auto" style="max-height: 60vh;">
                    <!-- รายการหัวข้อจะถูกโหลดใส่ที่นี่ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA CACHE ---
        let allOrdersData = []; 

        async function handleLogin() {
            const u = document.getElementById('l_user').value;
            const p = document.getElementById('l_pass').value;
            const { data, error } = await sb.from('users').select('*').eq('username', u).eq('password', p).single();
            if (error || !data) return alert("Login Failed!");
            currentUser = data;
            document.getElementById('login-page').classList.add('hidden');
            if (currentUser.role === 'admin') {
                document.getElementById('admin-layout').classList.remove('hidden');
                document.getElementById('user-display').innerText = currentUser.username;
                switchMenu('menu-upload');
                initAdminWebcam();
                subscribeRealtime();
                loadSettings();
            } else {
                document.getElementById('picker-layout').classList.remove('hidden');
                document.getElementById('p-name').innerText = currentUser.username;
                loadPickerTask();
                subscribeRealtime();
            }
        }

        function switchMenu(m) {
            document.querySelectorAll('.menu-section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('sidebar-item-active'));
            document.getElementById(m).classList.remove('hidden');
            document.getElementById('link-' + m.split('-')[1]).classList.add('sidebar-item-active');
            if(m === 'menu-settings') loadSettings();
            if(m === 'menu-review') loadReadyOrders();
            if(m === 'menu-upload') loadOrdersDashboard();
            if(m === 'menu-notif') loadNotifications();
            if(m === 'menu-kpi') loadKPI();
        }

        // --- DASHBOARD GROUPING LOGIC ---
        async function loadOrdersDashboard() {
            const dateFilter = document.getElementById('filter_date').value;
            const userFilter = document.getElementById('filter_user').value; // เพิ่มตัวกรอง User
            
            let query = sb.from('orders').select('*, users(username)');
            
            // กรองตามวันที่
            if(dateFilter) query = query.gte('created_at', dateFilter + 'T00:00:00').lte('created_at', dateFilter + 'T23:59:59');
            
            // กรองตามพนักงาน (assigned_to)
            if(userFilter) query = query.eq('assigned_to', userFilter);
            
            const { data } = await query.order('created_at', { ascending: false });
            allOrdersData = data || [];

            // Group by order_id
            const grouped = allOrdersData.reduce((acc, obj) => {
                const key = obj.order_id;
                if (!acc[key]) acc[key] = { id: key, items: [], picked: 0, total: 0, assigned: obj.users?.username, date: obj.created_at };
                acc[key].items.push(obj);
                acc[key].total++;
                if (obj.status !== 'pending') acc[key].picked++;
                return acc;
            }, {});

            const body = document.getElementById('dashboardBody');
            const sortedOrders = Object.values(grouped);
            
            body.innerHTML = sortedOrders.length ? sortedOrders.map(o => {
                const isComplete = o.picked === o.total;
                return `
                <tr class="hover:bg-blue-50 border-b border-gray-100 transition">
                    <td class="p-4 font-black text-blue-600">${o.id}</td>
                    <td class="p-4 text-base">${new Date(o.date).toLocaleString('th-TH')}</td>
                    <td class="p-4 text-base font-bold text-slate-700">${o.assigned || '---'}</td>
                    <td class="p-4 text-base">
                        <div class="text-base font-black">${o.picked} / ${o.total}</div>
                        <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                            <div class="bg-blue-600 h-1 rounded-full" style="width: ${(o.picked/o.total)*100}%"></div>
                        </div>
                    </td>
                    <td class="p-4">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${isComplete ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                            ${isComplete ? 'COMPLETED' : 'IN PROGRESS'}
                        </span>
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="openDetailModal('${o.id}')" class="text-blue-500 hover:text-blue-800 font-bold text-xs underline">
                            <i class="fas fa-eye mr-1"></i> View
                        </button>
                    </td>
                </tr>
            `;}).join('') : '<tr><td colspan="6" class="p-10 text-center text-gray-400 italic">No data found</td></tr>';
        }

        // --- MODAL LOGIC
        function openDetailModal(orderId) {
            const items = allOrdersData.filter(d => d.order_id === orderId);
            document.getElementById('modal-title').innerText = `ใบงาน: ${orderId}`;
            const body = document.getElementById('modal-body');
            
            body.innerHTML = items.map(item => {
                const imgSrc = `${PROJECT_A_IMAGE_URL}${item.product_code}.jpg`; // ลบ .js ออกแล้ว
                return `
                <tr class="hover:bg-blue-50 border-b transition">
                    <td class="p-4">
                        <img src="${imgSrc}" 
                             onclick="window.open('${imgSrc}', '_blank')"
                             class="w-16 h-16 rounded-xl shadow-md border-2 border-white cursor-pointer hover:scale-110 transition duration-300 object-cover"
                             onerror="this.onerror=null; this.src='https://placehold.co/100x100?text=NO+IMAGE';">
                    </td>
                    <td class="p-4">
                        <div class="font-black text-slate-800 text-xs">${item.product_name}</div>
                        <div class="text-[10px] text-gray-400 mt-1">${item.product_code}</div>
                    </td>
                    <td class="p-4 text-red-600 font-black text-xs uppercase tracking-tighter">${item.location}</td>
                    <td class="p-4 text-center font-black text-slate-700">${item.qty}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded-md text-[9px] font-black uppercase ${getStatusClass(item.status)}">${item.status}</span>
                    </td>
                </tr>
            `;}).join('');
            
            document.getElementById('detail-modal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        // --- REST OF THE LOGIC (SAME AS V3.1) ---
        async function handleUpload() {
            const file = document.getElementById('excelFile').files[0];
            const pickerId = document.getElementById('pickerSelect').value;
            if(!file || !pickerId) return alert("เลือกไฟล์และพนักงานก่อน!");
            const reader = new FileReader();
            reader.onload = async (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const orders = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                const parts = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[1]]);
                const orderData = orders.map(r => ({ order_id: String(r['รหัสทำรายการ']), product_code: String(r['รหัสสินค้า']), product_name: String(r['รายการสินค้า']), location: String(r['จุดเก็บ']), qty: r['จำนวนเบิก'], assigned_to: pickerId }));
                const partData = parts.map(r => ({ order_id: String(r['รหัสทำรายการ']), part_name: r['รายการ'], qty: r['จำนวน'] }));
                const { error: err1 } = await sb.from('orders').insert(orderData);
                const { error: err2 } = await sb.from('order_parts').insert(partData);
                if(!err1) { alert("อัปโหลดและจ่ายงานสำเร็จ!"); loadOrdersDashboard(); }
            };
            reader.readAsArrayBuffer(file);
        }

        async function loadSettings() {
            const { data: users } = await sb.from('users').select('*').order('created_at', { ascending: false });
            document.getElementById('userList').innerHTML = users.map(u => `<div class="flex justify-between items-center py-2"><div class="text-sm font-bold">${u.username} <span class="text-[10px] font-normal text-gray-400">(${u.role})</span></div><button onclick="deleteUser('${u.id}')" class="text-red-400"><i class="fas fa-trash-alt"></i></button></div>`).join('');
            document.getElementById('pickerSelect').innerHTML = '<option value="">-- เลือกพนักงาน --</option>' + users.filter(u => u.role === 'picker').map(u => `<option value="${u.id}">${u.username}</option>`).join('');
            document.getElementById('filter_user').innerHTML = '<option value="">พนักงานทั้งหมด</option>' + users.filter(u => u.role === 'picker').map(u => `<option value="${u.id}">${u.username}</option>`).join('');
            const { data: topics } = await sb.from('notification_topics').select('*').order('created_at', { ascending: false });
            document.getElementById('topicList').innerHTML = topics.map(t => `<div class="flex justify-between items-center py-2"><div class="text-sm">${t.topic_name}</div><button onclick="deleteTopic('${t.id}')" class="text-red-300"><i class="fas fa-times"></i></button></div>`).join('');
        }

        async function addUser() {
            const u = document.getElementById('nu').value, p = document.getElementById('np').value, r = document.getElementById('nr').value;
            if(!u || !p) return;
            await sb.from('users').insert([{ username: u, password: p, role: r }]);
            loadSettings();
        }

        function getStatusClass(s) {
            const map = { 'pending': 'bg-gray-100', 'picked': 'bg-blue-100 text-blue-700', 'correct': 'bg-green-100 text-green-700', 'wrong': 'bg-red-100 text-red-700' };
            return map[s] || 'bg-gray-50';
        }

        async function initAdminWebcam() {
            try { adminStream = await navigator.mediaDevices.getUserMedia({ video: true }); document.getElementById('webcam').srcObject = adminStream; } 
            catch(e) { console.warn("Cam init error"); }
        }
        // --- NEW PICKER LOGIC V.3.3 ---
        let pickerTimerInterval;

        async function loadPickerTask() {
            if (pickerTimerInterval) clearInterval(pickerTimerInterval);

            // 1. ดึงงานที่ได้รับมอบหมายรายการแรก
            const { data: job } = await sb.from('orders')
                .select('*')
                .eq('assigned_to', currentUser.id)
                .eq('status', 'pending')
                .order('created_at', { ascending: true })
                .limit(1);

            const jobCard = document.getElementById('p-job-card');
            const nextBtn = document.getElementById('p-btn-next');
            const noJobLabel = document.getElementById('p-no-job');

            if (job && job.length > 0) {
                const currentJob = job[0];
                currentUser.currentOrder = currentJob;

                // 2. คำนวณลำดับ (หาว่าใบงานนี้มีกี่ชิ้น และเราทำไปกี่ชิ้นแล้ว)
                const { count: totalCount } = await sb.from('orders')
                    .select('*', { count: 'exact', head: true })
                    .eq('order_id', currentJob.order_id);

                const { count: doneCount } = await sb.from('orders')
                    .select('*', { count: 'exact', head: true })
                    .eq('order_id', currentJob.order_id)
                    .neq('status', 'pending');

                // 3. แสดงผลข้อมูล
                jobCard.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
                noJobLabel.classList.add('hidden');

                document.getElementById('p-loc').innerText = currentJob.location;
                document.getElementById('p-prod').innerText = currentJob.product_name;
                document.getElementById('p-qty').innerText = currentJob.qty;
                document.getElementById('p-current-idx').innerText = (doneCount || 0) + 1;
                document.getElementById('p-total-items').innerText = totalCount || 0;
                
                // จัดการรูปภาพ
                const pImg = document.getElementById('p-img');
                pImg.src = `${PROJECT_A_IMAGE_URL}${currentJob.product_code}.jpg`;
                pImg.onerror = () => { pImg.src = 'https://placehold.co/500x500?text=NO+IMAGE'; };

                // 4. เริ่มตัวนับเวลา (นับจากเวลาที่งานถูกอัปโหลด/มอบหมาย)
                startPickerTimer(currentJob.created_at);
            } else {
                jobCard.classList.add('hidden');
                nextBtn.classList.add('hidden');
                noJobLabel.classList.remove('hidden');
                document.getElementById('p-timer').innerText = "00:00";
            }
        }

        function startPickerTimer(startTimeStr) {
            const start = new Date(startTimeStr).getTime();
            if (pickerTimerInterval) clearInterval(pickerTimerInterval); // เคลียร์ของเก่าก่อนเริ่มใหม่

            pickerTimerInterval = setInterval(() => {
                const now = new Date().getTime();
                const diff = Math.floor((now - start) / 1000); // ระยะเวลาเป็นวินาที
                
                const hrs = Math.floor(diff / 3600);
                const mins = Math.floor((diff % 3600) / 60);
                
                // แสดงผลรูปแบบ HH:MM (วินาทียังนับอยู่เบื้องหลังแต่ไม่โชว์ เพื่อความสะอาดของหน้าจอ)
                document.getElementById('p-timer').innerText = 
                    `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            }, 1000);
        }

        async function pickerFinishItem() {
            if (!currentUser.currentOrder) return;
            const { error } = await sb.from('orders')
                .update({ status: 'picked', start_time: new Date() })
                .eq('id', currentUser.currentOrder.id);
            if (!error) loadPickerTask();
        }

        // --- ระบบแจ้งเตือนแบบเลือกรายการ ---
        function openAlertModal() {
            document.getElementById('alert-modal').classList.remove('hidden');
            loadAlertTopics();
        }

        function closeAlertModal() {
            document.getElementById('alert-modal').classList.add('hidden');
        }

        async function loadAlertTopics() {
            const { data: topics } = await sb.from('notification_topics').select('topic_name');
            const container = document.getElementById('topic-options');
            if(!topics || topics.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-400 py-4 font-bold">ไม่มีหัวข้อแจ้งเตือนในระบบ</p>`;
                return;
            }
            container.innerHTML = topics.map(t => `
                <button onclick="submitPickerAlert('${t.topic_name}')" class="w-full text-left p-6 bg-slate-50 hover:bg-blue-50 active:bg-blue-100 rounded-[2rem] border border-slate-100 font-black text-xl text-slate-700 transition-all flex justify-between items-center group">
                    <span>${t.topic_name}</span>
                    <i class="fas fa-chevron-right text-slate-300 group-hover:text-blue-500"></i>
                </button>
            `).join('');
        }

        async function submitPickerAlert(topicName) {
            if (!currentUser.currentOrder) return;
            const { error } = await sb.from('notifications').insert([{ 
                type: topicName, 
                order_id: currentUser.currentOrder.order_id, 
                picker_id: currentUser.id 
            }]);
            if(!error) {
                alert("ส่งการแจ้งเตือนไปยังแอดมินแล้ว");
                closeAlertModal();
            }
        }
        function subscribeRealtime() {
            sb.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, () => {
                if(currentUser.role === 'admin') { loadReadyOrders(); loadOrdersDashboard(); loadKPI(); }
                else { loadPickerTask(); }
            }).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications' }, () => {
                if(currentUser.role === 'admin') { loadNotifications(); updateNotifBadge(); }
            }).subscribe();
        }

        async function loadNotifications() {
            const { data } = await sb.from('notifications').select('*, users(username)').order('created_at', { ascending: false });
            document.getElementById('notifList').innerHTML = data && data.length ? data.map(n => `<div class="p-4 flex justify-between items-center"><div class="text-red-600 font-bold text-sm">${n.type}</div><div>${n.status === 'unread' ? `<button onclick="fixNotif('${n.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-[10px]">Fix</button>` : `<span class="text-green-500 text-[10px]">✔ Fixed</span>`}</div></div>`).join('') : '';
        }

        async function loadKPI() {
            const { data } = await sb.from('orders').select('*').in('status', ['correct', 'wrong']);
            const total = data.length, correct = data.filter(o => o.status === 'correct').length;
            document.getElementById('kpiStats').innerHTML = `<div class="bg-white p-6 rounded-2xl border shadow-sm"><div class="text-3xl font-black">${total}</div><div class="text-[10px] text-gray-400">Total Packed</div></div><div class="bg-white p-6 rounded-2xl border shadow-sm"><div class="text-3xl font-black">${total > 0 ? ((correct/total)*100).toFixed(1) : 0}%</div><div class="text-[10px] text-green-500 font-bold uppercase">Accuracy</div></div>`;
        }

        async function updateNotifBadge() {
            const { count } = await sb.from('notifications').select('*', { count: 'exact', head: true }).eq('status', 'unread');
            const badge = document.getElementById('notif-badge');
            if (count > 0) { badge.innerText = count; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
        }

        function logout() { 
            if(pickerTimerInterval) clearInterval(pickerTimerInterval);
            location.reload(); 
        }
        async function deleteUser(id) { await sb.from('users').delete().eq('id', id); loadSettings(); }
        async function deleteTopic(id) { await sb.from('notification_topics').delete().eq('id', id); loadSettings(); }
    </script>
</body>
</html>
